<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --text:#0a0a0a;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#111111;
      --accent-weak:#f6f7f8;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; background:var(--bg); color:var(--text)}

    .header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
    .header-inner{max-width:900px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:24px}
    .btn{border:1px solid var(--line);background:#fff;color:var(--text);padding:8px 14px;border-radius:999px;cursor:pointer;font-weight:600;text-decoration:none;display:inline-flex;align-items:center}
    .btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}

    .container{max-width:900px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:1fr 260px;gap:18px}
    @media (max-width: 960px){.container{grid-template-columns:1fr}}

    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px}
    .title{font-size:18px;font-weight:700;margin-bottom:10px}

    .form-row{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    label{font-weight:600;font-size:14px}
    input[type="text"], input[type="password"]{padding:10px;border:1px solid var(--line);border-radius:8px;font-size:14px}

    .avatar-preview{width:72px;height:72px;border-radius:50%;border:2px solid #111;background:#f2f2f2;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:32px}

    .icons-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(48px,1fr));gap:8px;margin-top:10px}
    .icon-item{display:flex;align-items:center;justify-content:center;border:1px solid var(--line);border-radius:10px;height:48px;cursor:pointer;background:#fff;font-size:24px}
    .icon-item.selected{outline:2px solid #111}

    .muted{color:var(--muted);font-size:13px}
    .danger{color:#c00}
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="brand">Meddialog</div>
      <div>
        <a class="btn" href="profile.html">‚Üê –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ—Ñ–∏–ª—é</a>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>

      <div class="form-row">
        <label>–ò–∫–æ–Ω–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è</label>
        <div class="avatar-preview" id="avatarPreview">U</div>
        <div class="icons-grid" id="iconsGrid"></div>
        <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
          <button class="btn" id="clearIconBtn" type="button">–£–¥–∞–ª–∏—Ç—å –∏–∫–æ–Ω–∫—É</button>
        </div>
        <div class="muted">–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏/–∏–∫–æ–Ω–∫—É –∏–ª–∏ —É–¥–∞–ª–∏—Ç–µ –µ—ë. –ï—Å–ª–∏ –∏–∫–æ–Ω–∫–∏ –Ω–µ—Ç, –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ –ø–µ—Ä–≤–∞—è –±—É–∫–≤–∞ –∏–º–µ–Ω–∏.</div>
      </div>

      <div class="form-row">
        <label>–§–æ—Ç–æ-–∞–≤–∞—Ç–∞—Ä</label>
        <input type="file" id="avatarFile" accept="image/*" />
        <div class="muted">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –≤—ã —É–≤–∏–¥–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä. –ó–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ¬ª, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.</div>
        <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
          <button class="btn" id="uploadAvatarBtn" type="button">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
          <button class="btn" id="clearPhotoBtn" type="button">–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ</button>
        </div>
        <div class="muted" id="photoMsg"></div>
      </div>

      <div class="form-row">
        <label for="displayName">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
        <input type="text" id="displayName" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" />
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
        <button class="btn btn-primary" id="saveProfileBtn" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <a class="btn" href="profile.html">–û—Ç–º–µ–Ω–∞</a>
      </div>
    </section>

    <aside class="card">
      <div class="title">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</div>
      <div class="form-row">
        <label for="currentPassword">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
        <input type="password" id="currentPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <div class="form-row">
        <label for="newPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
        <input type="password" id="newPassword" placeholder="–ù–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤" />
      </div>
      <div class="form-row">
        <label for="confirmPassword">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
        <input type="password" id="confirmPassword" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" />
      </div>
      <button class="btn" id="changePasswordBtn" type="button">–û–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
      <p class="muted" id="passwordMsg">–ü–æ–∫–∞ —á—Ç–æ —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ API. –ú—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å; –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ API –æ–Ω –Ω–∞—á–Ω—ë—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.</p>
    </aside>
  </main>

  <script>
    const ICONS = [
      'üòÄ','üòé','üßë\u200d‚öïÔ∏è','üë©\u200d‚öïÔ∏è','üß†','‚ù§Ô∏è','üíô','üíä','ü©∫','üß¨','üß™','‚öïÔ∏è','üè•','üåø','üåü','üê±','üê∂','üêº','üöÄ','üéØ','üìö'
    ];

    function getStoredUser(){
      try { return JSON.parse(localStorage.getItem('user') || 'null'); } catch { return null; }
    }
    function setStoredUser(user){
      localStorage.setItem('user', JSON.stringify(user));
    }

    // Prefill UI
    const user = getStoredUser();
    let tempPhotoUrl = null; // –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ, –Ω–æ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    const displayNameInput = document.getElementById('displayName');
    const avatarPreview = document.getElementById('avatarPreview');
    const iconsGrid = document.getElementById('iconsGrid');

    function updatePreview(){
      const name = (displayNameInput.value || user?.name || 'U').trim();
      const letter = name ? name[0].toUpperCase() : 'U';
      const icon = (user && user.avatar_icon) ? user.avatar_icon : null;
      const url = tempPhotoUrl || (user && user.avatar_url) || null;
      if (url){
        avatarPreview.innerHTML = `<img src="${url}" alt="avatar" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" />`;
      } else {
        avatarPreview.textContent = icon ? icon : letter;
      }
    }

    function renderIconsGrid(selected){
      iconsGrid.innerHTML = '';
      ICONS.forEach(ic => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'icon-item' + (selected === ic ? ' selected' : '');
        btn.textContent = ic;
        btn.addEventListener('click', () => {
          if (!user) return;
          user.avatar_icon = ic;
          setStoredUser(user);
          renderIconsGrid(ic);
          updatePreview();
        });
        iconsGrid.appendChild(btn);
      });
    }

    if (user){
      displayNameInput.value = user.name || '';
      renderIconsGrid(user.avatar_icon || null);
    } else {
      renderIconsGrid(null);
    }
    updatePreview();

    // Listeners
    displayNameInput.addEventListener('input', updatePreview);

    document.getElementById('clearIconBtn').addEventListener('click', () => {
      if (!user) return;
      delete user.avatar_icon;
      setStoredUser(user);
      renderIconsGrid(null);
      updatePreview();
    });

    document.getElementById('saveProfileBtn').addEventListener('click', async () => {
      if (!user){
        alert('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.');
        return;
      }
      const newName = displayNameInput.value.trim();
      if (!newName){
        alert('–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
        return;
      }
      // –°–æ—Ö—Ä–∞–Ω–∏–º –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      try{
        const fd = new FormData();
        fd.append('user_uniq_id', user.uniq_id||'');
        fd.append('name', newName);
        fd.append('avatar_icon', user.avatar_icon || '');
        fd.append('avatar_url', user.avatar_url || '');
        const resp = await fetch('../server/update_user_profile_api_server.php', { method: 'POST', body: fd });
        const data = await resp.json();
        if (!resp.ok || !data.ok){ throw new Error((data && data.error) ? data.error : '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è'); }
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º localStorage —Å —Å–µ—Ä–≤–µ—Ä–æ–º
        setStoredUser({
          id: data.user.id,
          name: data.user.name,
          email: data.user.email,
          uniq_id: data.user.uniq_id,
          avatar_icon: data.user.avatar_icon || null,
          avatar_url: data.user.avatar_url || null,
        });
        // –í–µ—Ä–Ω—ë–º—Å—è –∫ –ø—Ä–æ—Ñ–∏–ª—é
        window.location.href = 'profile.html';
      } catch(err){
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä: ' + err.message);
      }
    });

    document.getElementById('changePasswordBtn').addEventListener('click', async () => {
      const cur = document.getElementById('currentPassword').value;
      const np = document.getElementById('newPassword').value;
      const cp = document.getElementById('confirmPassword').value;
      const msg = document.getElementById('passwordMsg');

      if (!user){ msg.textContent = '–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.'; return; }
      if (!np || np.length < 6){ msg.textContent = '–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤.'; return; }
      if (np !== cp){ msg.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.'; return; }

      // –í—ã–∑–æ–≤ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ API —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
      try{
        msg.textContent = '–û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å...';
        const fd = new FormData();
        fd.append('type','change_password');
        fd.append('user_uniq_id', user.uniq_id||'');
        fd.append('current_password', cur);
        fd.append('new_password', np);
        const resp = await fetch('../server/register_login_api_server.php', { method: 'POST', body: fd });
        const data = await resp.json();
        if (!resp.ok || !data.ok){
          throw new Error(data && data.error ? data.error : '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è');
        }
        msg.textContent = '–ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω.';
        // –û—á–∏—Å—Ç–∏–º –ø–æ–ª—è
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
      } catch(err){
        msg.textContent = err.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è';
      }
    });

    // –§–æ—Ç–æ-–∞–≤–∞—Ç–∞—Ä: –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    const avatarFile = document.getElementById('avatarFile');
    const uploadBtn = document.getElementById('uploadAvatarBtn');
    const clearPhotoBtn = document.getElementById('clearPhotoBtn');
    const photoMsg = document.getElementById('photoMsg');

    avatarFile.addEventListener('change', () => {
      const f = avatarFile.files && avatarFile.files[0];
      if (!f){ tempPhotoUrl = null; updatePreview(); return; }
      // preview before upload
      tempPhotoUrl = URL.createObjectURL(f);
      updatePreview();
      photoMsg.textContent = '–ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ¬ª, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å.';
    });

    uploadBtn.addEventListener('click', async () => {
      const f = avatarFile.files && avatarFile.files[0];
      if (!user){ alert('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã'); return; }
      if (!f){ alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª'); return; }
      try{
        photoMsg.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        const fd = new FormData();
        fd.append('user_uniq_id', user.uniq_id||'');
        fd.append('avatar', f);
        const resp = await fetch('../server/upload_avatar_api_server.php', { method: 'POST', body: fd });
        const data = await resp.json();
        if (!resp.ok || !data.ok){ throw new Error((data && data.error) ? data.error : '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); }
        user.avatar_url = data.avatar_url;
        setStoredUser(user);
        // –æ—á–∏—Å—Ç–∏–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç
        if (tempPhotoUrl){ URL.revokeObjectURL(tempPhotoUrl); tempPhotoUrl = null; }
        updatePreview();
        photoMsg.textContent = '–§–æ—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ.';
      } catch(err){
        photoMsg.textContent = err.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ';
      }
    });

    clearPhotoBtn.addEventListener('click', () => {
      if (!user) return;
      user.avatar_url = null;
      setStoredUser(user);
      if (tempPhotoUrl){ URL.revokeObjectURL(tempPhotoUrl); tempPhotoUrl = null; }
      updatePreview();
      photoMsg.textContent = '–§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ. –ë—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ —ç–º–æ–¥–∑–∏/–±—É–∫–≤–∞.';
    });
  </script>
</body>
</html>
